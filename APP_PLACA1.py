import paho.mqtt.client as mqtt
import re
import requests
import time
from datetime import datetime
import numpy as np
import tensorflow as tf
from tensorflow import keras
from tensorflow.keras.models import load_model


# Configuraci√≥n del broker MQTT
mqtt_broker = "test.mosquitto.org"
mqtt_port = 1883
mqtt_topic = "esp32/test11"


contador1 = 0


# Datos de entrada y salida
input_data = np.array([[4240, 4244, 4357, 4384, 4385, 4412, 4421, 4440, 4444, 4428, 4428, 4441, 4453, 4449, 4445, 4461, 4481, 4493, 4501, 4505, 4512, 4500, 4493, 4513, 4521, 4501, 4540, 4553, 4552, 4552, 4500, 6689, 4545, 4541, 4536, 4472, 4480, 4528, 7885, 7545, 4596, 4705, 4704, 4736, 4709, 4744, 4752, 4749, 4741, 7700, 6104, 6088, 6069, 6041, 6005, 5980, 5956, 5924, 5881, 5925, 5805, 5753, 5677, 5677, 5637, 5584, 5560, 5509, 5452, 5420, 5484, 5388, 5369, 5332, 5201, 5189, 5153, 5076, 5028, 4985, 5013, 5036, 5033, 5037, 5024, 4992, 4980, 4960, 4932, 4936, 4929, 4905, 4889, 4876, 4857, 4841, 4836, 4821, 4816, 4777, 4772, 4753, 4753, 4716, 4709, 4681, 4684, 4685, 4629, 4624, 4616, 4620, 4620, 4617, 4625, 4612, 4616, 4609, 4597, 4589, 4585, 4580, 4577, 4580, 4529, 4540, 4537, 4533, 4536, 4532, 4516, 4516, 4504, 4488, 4512, 4257, 4968, 5112, 5209, 5276, 5321, 5412, 5425, 5456, 6309, 6301, 6289, 6264, 6252, 6213, 6212, 6169, 6168, 6172],
    [3801, 3804, 3908, 3917, 3917, 3929, 3941, 3956, 3960, 3949, 3949, 3953, 3964, 3961, 3968, 3964, 3980, 3981, 3996, 3996, 4001, 4021, 4020, 4013, 4029, 4013, 4028, 4041, 4029, 4052, 4020, 6004, 4045, 4025, 4036, 3992, 3989, 4072, 7221, 6881, 4209, 4221, 4217, 4228, 4212, 4220, 4224, 4228, 4244, 6980, 5149, 5140, 5116, 5096, 5064, 5044, 5028, 5005, 4977, 5021, 4929, 4901, 4888, 4869, 4848, 4813, 4792, 4769, 4737, 4721, 4781, 4713, 4705, 4673, 4577, 4564, 4533, 4473, 4444, 4416, 4432, 4449, 4448, 4457, 4452, 4420, 4405, 4392, 4376, 4369, 4368, 4345, 4332, 4320, 4300, 4293, 4288, 4280, 4277, 4256, 4241, 4232, 4225, 4200, 4196, 4168, 4156, 4149, 4125, 4124, 4120, 4112, 4116, 4116, 4093, 4112, 4109, 4093, 4077, 4073, 4072, 4065, 4064, 4073, 4064, 4061, 4064, 4061, 4060, 4057, 4053, 4020, 4017, 3901, 4036, 3828, 4524, 4560, 4597, 4632, 4680, 4733, 4749, 4769, 5309, 5293, 5272, 5261, 5249, 5225, 5224, 5192, 5193, 5196],
    [3640, 3645, 3780, 3800, 3816, 3836, 3841, 3861, 3857, 3853, 3849, 3860, 3880, 3880, 3880, 3900, 3908, 3916, 3929, 3937, 3941, 3933, 3928, 3940, 3948, 3944, 3965, 3985, 3992, 3985, 3948, 6124, 3984, 3968, 3972, 3921, 3917, 3984, 7460, 7057, 4080, 4165, 4152, 4180, 4161, 4188, 4196, 4196, 4200, 7224, 5017, 5004, 5000, 4981, 4953, 4932, 4913, 4896, 4861, 4916, 4816, 4793, 4760, 4757, 4732, 4704, 4688, 4660, 4640, 4621, 4689, 4629, 4629, 4597, 4493, 4488, 4457, 4397, 4381, 4345, 4377, 4400, 4409, 4408, 4397, 4380, 4361, 4352, 4333, 4341, 4341, 4320, 4301, 4305, 4284, 4280, 4261, 4261, 4244, 4225, 4220, 4205, 4205, 4181, 4172, 4148, 4152, 4153, 4116, 4117, 4092, 4117, 4113, 4116, 4121, 4124, 4125, 4121, 4093, 4093, 4092, 4084, 4084, 4085, 4053, 4053, 4045, 4049, 4057, 4048, 4044, 4040, 4044, 4021, 4048, 3649, 4492, 4580, 4640, 4693, 4736, 4828, 4836, 4864, 5197, 5184, 5169, 5148, 5145, 5093, 5092, 5060, 5053, 5073],
    [3928, 3925, 4093, 4125, 4125, 4169, 4172, 4208, 4205, 4216, 4212, 4216, 4248, 4240, 4253, 4256, 4281, 4296, 4316, 4308, 4325, 4329, 4337, 4345, 4365, 4356, 4393, 4405, 4397, 4413, 4372, 6796, 4429, 4420, 4416, 4356, 4364, 4441, 8109, 7744, 4548, 4628, 4636, 4657, 4633, 4657, 4660, 4668, 4673, 7921, 5460, 5445, 5448, 5428, 5396, 5373, 5364, 5341, 5300, 5357, 5253, 5248, 5228, 5217, 5189, 5160, 5152, 5116, 5076, 5064, 5164, 5081, 5084, 5041, 4929, 4917, 4889, 4805, 4809, 4772, 4808, 4825, 4840, 4852, 4844, 4813, 4793, 4780, 4760, 4761, 4792, 4756, 4725, 4729, 4713, 4693, 4688, 4700, 4684, 4656, 4652, 4640, 4629, 4600, 4600, 4557, 4573, 4561, 4548, 4545, 4537, 4540, 4540, 4540, 4541, 4545, 4549, 4553, 4533, 4545, 4525, 4536, 4528, 4537, 4501, 4512, 4513, 4505, 4509, 4509, 4501, 4505, 4504, 4485, 4508, 3932, 4804, 4912, 4981, 5061, 5116, 5237, 5248, 5272, 5580, 5568, 5564, 5561, 5549, 5521, 5525, 5501, 5497, 5512],
    [3729, 3728, 3880, 3900, 3905, 3921, 3932, 3952, 3961, 3960, 3957, 3957, 3968, 3968, 3981, 3981, 4004, 4021, 4029, 4032, 4037, 4061, 4064, 4060, 4077, 4068, 4085, 4124, 4116, 4125, 4073, 6316, 4125, 4112, 4113, 4041, 4053, 4144, 7625, 7256, 4244, 4300, 4296, 4312, 4304, 4320, 4324, 4325, 4344, 7424, 5169, 5161, 5160, 5116, 5093, 5076, 5061, 5044, 5012, 5052, 4968, 4948, 4925, 4917, 4901, 4865, 4849, 4840, 4800, 4785, 4860, 4796, 4792, 4764, 4657, 4640, 4617, 4469, 4533, 4501, 4525, 4549, 4553, 4569, 4557, 4536, 4525, 4504, 4480, 4492, 4485, 4473, 4452, 4437, 4429, 4413, 4401, 4401, 4401, 4380, 4372, 4352, 4344, 4325, 4324, 4292, 4289, 4281, 4268, 4264, 4261, 4253, 4252, 4257, 4261, 4261, 4260, 4257, 4245, 4249, 4241, 4240, 4229, 4244, 4217, 4224, 4224, 4217, 4228, 4224, 4216, 4208, 4201, 4125, 4217, 3728, 4544, 4601, 4657, 4716, 4764, 4848, 4856, 4884, 5296, 5273, 5276, 5257, 5248, 5229, 5229, 5205, 5200, 5213],
    [3529, 3528, 3680, 3708, 3705, 3724, 3733, 3752, 3761, 3757, 3753, 3749, 3773, 3772, 3773, 3785, 3797, 3809, 3817, 3832, 3841, 3860, 3864, 3852, 3877, 3861, 3884, 3904, 3893, 3909, 3877, 6092, 3916, 3901, 3909, 3861, 3857, 3940, 7449, 7072, 4060, 4089, 4109, 4125, 4088, 4120, 4125, 4141, 4152, 7240, 4948, 4944, 4933, 4913, 4884, 4868, 4848, 4825, 4792, 4852, 4741, 4729, 4717, 4708, 4680, 4644, 4629, 4608, 4576, 4569, 4633, 4565, 4564, 4536, 4429, 4424, 4388, 4180, 4305, 4277, 4297, 4316, 4312, 4328, 4309, 4289, 4284, 4257, 4245, 4244, 4244, 4225, 4212, 4193, 4177, 4172, 4157, 4153, 4160, 4125, 4121, 4113, 4081, 4061, 4061, 4033, 4024, 4028, 4012, 4005, 4004, 4005, 3997, 4000, 4008, 3997, 3993, 4004, 3988, 3988, 3981, 3977, 3980, 3992, 3969, 3969, 3969, 3968, 3972, 3969, 3968, 3944, 3944, 3836, 3956, 3533, 4317, 4373, 4421, 4485, 4525, 4593, 4608, 4628, 5085, 5065, 5060, 5045, 5041, 5012, 5009, 4988, 4988, 4997],
    [3848, 3845, 3965, 3984, 3988, 4009, 4009, 4016, 4032, 4024, 4024, 4012, 4033, 4029, 4037, 4029, 4049, 4065, 4073, 4089, 4120, 4120, 4124, 4093, 4140, 4093, 4137, 4157, 4156, 4173, 4125, 6292, 4169, 4156, 4156, 4117, 4116, 4193, 7532, 7216, 4329, 4353, 4353, 4365, 4329, 4352, 4360, 4380, 4393, 7368, 5073, 5073, 5061, 5040, 5012, 4996, 4981, 4960, 4928, 4984, 4888, 4864, 4856, 4836, 4804, 4777, 4756, 4741, 4712, 4708, 4768, 4700, 4692, 4676, 4569, 4564, 4528, 4469, 4429, 4393, 4416, 4440, 4436, 4444, 4436, 4424, 4400, 4380, 4369, 4373, 4360, 4345, 4348, 4313, 4309, 4297, 4285, 4284, 4296, 4256, 4249, 4244, 4236, 4224, 4221, 4196, 4184, 4188, 4172, 4169, 4168, 4165, 4164, 4168, 4156, 4153, 4160, 4169, 4144, 4141, 4137, 4140, 4140, 4148, 4145, 4148, 4149, 4140, 4125, 4125, 4125, 4093, 4080, 3968, 4120, 3860, 4496, 4549, 4596, 4653, 4700, 4757, 4772, 4780, 5229, 5216, 5208, 5192, 5176, 5156, 5149, 5133, 5112, 5136],
    [4377, 4381, 4572, 4596, 4600, 4625, 4633, 4649, 4661, 4653, 4653, 4649, 4676, 4676, 4549, 4677, 4693, 4720, 4728, 4753, 4757, 4757, 4764, 4760, 4792, 4777, 4805, 4832, 4825, 4836, 4797, 7156, 4837, 4821, 4820, 4764, 4772, 4849, 8191, 8057, 4953, 5017, 5032, 5048, 5016, 5041, 5049, 5068, 5068, 8191, 6220, 6201, 6197, 6173, 6128, 6117, 6093, 6073, 6037, 6093, 5993, 5961, 5941, 5921, 5905, 5861, 5845, 5817, 5780, 5765, 5840, 5764, 5753, 5728, 5589, 5577, 5548, 5484, 5436, 5396, 5425, 5449, 5452, 5445, 5440, 5412, 5388, 5365, 5345, 5341, 5325, 5308, 5289, 5264, 5252, 5240, 5229, 5225, 5212, 5189, 5184, 5168, 5153, 5108, 5104, 5076, 5056, 5057, 5024, 5021, 5024, 5017, 5017, 5020, 5016, 5013, 5005, 5013, 4992, 4993, 4992, 4993, 4989, 4992, 4961, 4972, 4972, 4965, 4969, 4961, 4961, 4937, 4929, 4824, 4852, 4393, 5252, 5341, 5425, 5505, 5565, 5661, 5668, 5700, 6361, 6349, 6333, 6324, 6308, 6289, 6284, 6257, 6257, 6272],
    [3321, 3321, 3416, 3437, 3433, 3441, 3445, 3449, 3461, 3453, 3460, 3441, 3461, 3464, 3364, 3453, 3449, 3476, 3484, 3492, 3513, 3505, 3509, 3489, 3520, 3500, 3517, 3532, 3512, 3528, 3504, 5496, 3537, 3517, 3517, 3480, 3476, 3565, 6749, 6408, 3709, 3689, 3705, 3708, 3672, 3684, 3693, 3713, 3721, 6501, 4801, 4788, 4781, 4760, 4716, 4697, 4677, 4645, 4616, 4661, 4561, 4529, 4509, 4488, 4460, 4421, 4404, 4365, 4328, 4313, 4376, 4301, 4280, 4257, 4161, 4152, 4109, 4045, 3992, 3961, 3969, 3985, 3984, 3988, 3977, 3952, 3925, 3913, 3897, 3892, 3884, 3856, 3861, 3816, 3800, 3793, 3780, 3776, 3777, 3741, 3736, 3724, 3713, 3673, 3676, 3645, 3624, 3620, 3596, 3593, 3589, 3589, 3589, 3593, 3584, 3569, 3572, 3569, 3557, 3549, 3544, 3548, 3541, 3552, 3557, 3564, 3572, 3557, 3549, 3541, 3548, 3496, 3488, 3397, 3512, 3349, 3996, 4028, 4064, 4116, 4149, 4213, 4217, 4236, 4941, 4929, 4917, 4897, 4897, 4872, 4864, 4845, 4841, 4848],
    [3861, 3872, 4036, 4060, 4069, 4093, 4124, 4141, 4148, 4141, 4125, 4149, 4164, 4157, 4032, 4192, 4216, 4245, 4261, 4265, 4265, 4269, 4272, 4288, 4309, 4305, 4329, 4345, 4353, 4361, 4325, 6684, 4365, 4356, 4357, 4300, 4313, 4373, 7996, 7617, 4460, 4569, 4553, 4588, 4572, 4612, 4617, 4612, 4601, 7784, 5413, 5401, 5396, 5376, 5348, 5341, 5332, 5309, 5280, 5333, 5236, 5209, 5173, 5173, 5157, 5109, 5108, 5080, 5057, 5036, 5112, 5057, 5056, 5013, 4901, 4888, 4857, 4792, 4777, 4744, 4788, 4816, 4817, 4816, 4817, 4804, 4789, 4773, 4756, 4757, 4752, 4737, 4713, 4705, 4689, 4684, 4681, 4669, 4660, 4637, 4641, 4628, 4616, 4604, 4601, 4588, 4577, 4576, 4549, 4541, 4545, 4552, 4545, 4541, 4545, 4544, 4548, 4541, 4533, 4536, 4541, 4536, 4532, 4533, 4488, 4481, 4485, 4481, 4492, 4504, 4477, 4505, 4509, 4369, 4496, 3864, 4692, 4785, 4861, 4932, 4973, 5065, 5081, 5109, 5552, 5532, 5517, 5504, 5497, 5480, 5472, 5449, 5448, 5453],
    [3393, 3397, 3569, 3588, 3597, 3632, 3637, 3660, 3665, 3657, 3656, 3677, 3693, 3689, 3593, 3721, 3736, 3753, 3769, 3785, 3784, 3785, 3784, 3804, 3820, 3817, 3848, 3876, 3876, 3873, 3832, 6160, 3885, 3869, 3880, 3824, 3833, 3884, 7541, 7124, 3969, 4068, 4060, 4092, 4076, 4125, 4125, 4117, 4109, 7304, 4869, 4865, 4857, 4841, 4816, 4805, 4789, 4768, 4737, 4797, 4704, 4673, 4648, 4637, 4632, 4601, 4593, 4564, 4541, 4524, 4605, 4537, 4537, 4505, 4389, 4384, 4352, 4293, 4268, 4245, 4277, 4312, 4309, 4305, 4305, 4300, 4284, 4265, 4249, 4256, 4248, 4233, 4217, 4208, 4197, 4188, 4184, 4176, 4160, 4125, 4141, 4125, 4124, 4093, 4088, 4072, 4069, 4081, 4048, 4044, 4044, 4049, 4048, 4045, 4045, 4049, 4053, 4045, 4040, 4044, 4040, 4044, 4052, 4048, 3997, 3997, 4000, 3997, 4005, 4012, 3988, 4016, 4016, 3909, 4012, 3397, 4337, 4413, 4480, 4553, 4596, 4692, 4705, 4736, 4997, 4992, 4981, 4957, 4953, 4933, 4929, 4912, 4901, 4909],
    [3968, 3968, 4124, 4145, 4157, 4184, 4184, 4208, 4216, 4205, 4205, 4212, 4224, 4228, 4221, 4240, 4248, 4273, 4284, 4292, 4297, 4301, 4304, 4300, 4313, 4305, 4336, 4341, 4341, 4348, 4305, 6521, 4337, 4325, 4332, 4277, 4277, 4345, 7757, 7401, 4441, 4509, 4501, 4529, 4501, 4521, 4533, 4540, 4532, 7508, 5345, 5340, 5336, 5317, 5288, 5276, 5260, 5241, 5216, 5257, 5176, 5152, 5116, 5104, 5084, 5053, 5041, 5012, 4989, 4976, 5049, 4988, 4973, 4949, 4845, 4832, 4801, 4740, 4708, 4685, 4720, 4736, 4736, 4745, 4744, 4717, 4709, 4688, 4672, 4669, 4668, 4652, 4637, 4624, 4613, 4597, 4580, 4584, 4576, 4549, 4549, 4536, 4524, 4500, 4496, 4476, 4469, 4468, 4445, 4441, 4444, 4441, 4444, 4444, 4441, 4440, 4444, 4440, 4428, 4428, 4421, 4421, 4420, 4424, 4401, 4408, 4405, 4396, 4401, 4401, 4392, 4380, 4377, 4257, 4388, 3973, 4856, 4932, 4989, 5052, 5093, 5204, 5220, 5245, 5484, 5469, 5457, 5445, 5441, 5412, 5408, 5384, 5385, 5389],
    [3032, 3041, 3220, 3233, 3240, 3261, 3269, 3301, 3301, 3305, 3301, 3305, 3320, 3324, 3329, 3341, 3353, 3369, 3380, 3385, 3401, 3420, 3429, 3432, 3448, 3417, 3464, 3473, 3477, 3481, 3449, 5709, 3497, 3480, 3480, 3437, 3441, 3509, 7156, 6736, 3629, 3669, 3673, 3692, 3673, 3684, 3688, 3697, 3708, 6888, 4452, 4445, 4437, 4408, 4397, 4365, 4364, 4344, 4312, 4357, 4264, 4248, 4240, 4232, 4212, 4184, 4169, 4156, 4121, 4113, 4184, 4125, 4117, 4077, 3977, 3976, 3948, 3893, 3861, 3853, 3868, 3896, 3900, 3917, 3908, 3889, 3876, 3864, 3837, 3837, 3849, 3829, 3805, 3805, 3796, 3789, 3776, 3769, 3772, 3748, 3744, 3736, 3720, 3697, 3704, 3673, 3669, 3664, 3648, 3648, 3644, 3636, 3637, 3641, 3652, 3644, 3648, 3649, 3637, 3637, 3628, 3633, 3632, 3641, 3620, 3621, 3629, 3620, 3621, 3621, 3617, 3608, 3597, 3557, 3576, 3044, 3937, 3981, 4032, 4084, 4149, 4236, 4249, 4276, 4584, 4505, 4549, 4544, 4541, 4509, 4512, 4493, 4493, 4504],
    [3912, 3916, 4021, 4044, 4049, 4077, 4077, 4116, 4117, 4113, 4089, 4093, 4125, 4125, 4125, 4149, 4157, 4177, 4181, 4184, 4193, 4180, 4177, 4188, 4200, 4188, 4201, 4220, 4220, 4221, 4173, 6376, 4213, 4201, 4196, 4141, 4141, 4212, 7637, 7265, 4293, 4369, 4356, 4380, 4361, 4385, 4389, 4392, 4385, 7381, 5405, 5397, 5392, 5372, 5341, 5320, 5305, 5280, 5252, 5300, 5209, 5180, 5152, 5152, 5104, 5073, 5053, 5025, 4993, 4980, 5044, 4984, 4972, 4941, 4828, 4821, 4788, 4728, 4701, 4668, 4696, 4716, 4725, 4725, 4713, 4685, 4668, 4657, 4636, 4633, 4637, 4621, 4596, 4592, 4569, 4564, 4548, 4544, 4525, 4500, 4501, 4485, 4476, 4448, 4449, 4416, 4420, 4416, 4373, 4373, 4376, 4380, 4380, 4376, 4380, 4380, 4377, 4373, 4361, 4365, 4353, 4349, 4348, 4352, 4325, 4328, 4328, 4321, 4328, 4317, 4316, 4312, 4312, 4257, 4309, 3925, 4768, 4853, 4892, 4961, 5020, 5105, 5144, 5169, 5580, 5505, 5544, 5524, 5524, 5485, 5481, 5456, 5456, 5461],
    [3176, 3173, 3220, 3225, 3232, 3240, 3245, 3257, 3260, 3252, 3241, 3233, 3252, 3248, 3244, 3248, 3265, 3265, 3272, 3269, 3276, 3296, 3280, 3260, 3288, 3249, 3265, 3277, 3265, 3276, 3245, 5033, 3253, 3240, 3237, 3209, 3205, 3264, 6200, 5857, 3361, 3372, 3361, 3364, 3349, 3364, 3349, 3376, 3397, 5952, 4169, 4164, 4161, 4125, 4092, 4069, 4064, 4037, 4012, 4048, 3968, 3960, 3933, 3921, 3897, 3877, 3868, 3844, 3821, 3809, 3860, 3813, 3809, 3788, 3700, 3689, 3664, 3608, 3608, 3572, 3584, 3597, 3605, 3617, 3612, 3581, 3565, 3556, 3537, 3536, 3553, 3525, 3501, 3517, 3505, 3493, 3477, 3473, 3480, 3428, 3428, 3420, 3420, 3388, 3388, 3357, 3360, 3352, 3329, 3328, 3317, 3309, 3317, 3309, 3317, 3317, 3325, 3324, 3305, 3297, 3289, 3281, 3281, 3292, 3276, 3268, 3265, 3260, 3256, 3253, 3256, 3229, 3232, 3197, 3240, 3196, 3649, 3680, 3712, 3733, 3768, 3824, 3825, 3845, 4324, 4261, 4296, 4281, 4277, 4244, 4241, 4220, 4220, 4221],
    [3540, 3541, 3657, 3681, 3689, 3709, 3712, 3733, 3741, 3736, 3728, 3736, 3753, 3749, 3753, 3764, 3796, 3788, 3800, 3804, 3812, 3825, 3824, 3820, 3840, 3824, 3841, 3865, 3852, 3857, 3825, 5909, 3865, 3845, 3857, 3808, 3808, 3888, 7149, 6800, 3968, 4020, 4017, 4032, 4016, 4029, 4033, 4045, 4052, 6913, 5008, 4996, 4992, 4969, 4936, 4925, 4904, 4884, 4852, 4896, 4804, 4773, 4737, 4733, 4704, 4669, 4657, 4624, 4589, 4565, 4633, 4556, 4537, 4504, 4400, 4392, 4353, 4288, 4261, 4232, 4249, 4269, 4272, 4276, 4268, 4233, 4221, 4209, 4189, 4185, 4188, 4169, 4141, 4140, 4125, 4109, 4085, 4088, 4080, 4045, 4037, 4029, 4021, 3996, 3993, 3965, 3965, 3961, 3932, 3929, 3921, 3924, 3933, 3925, 3929, 3920, 3925, 3929, 3913, 3909, 3901, 3904, 3908, 3905, 3880, 3884, 3885, 3876, 3881, 3881, 3876, 3853, 3856, 3808, 3865, 3561, 4265, 4357, 4424, 4481, 4532, 4613, 4625, 4669, 5173, 5077, 5152, 5116, 5109, 5081, 5073, 5052, 5045, 5056],
])

output_data = np.array([1150, 1164, 1091, 1091, 1042, 1033, 1033, 1016, 1017, 1023, 1029, 1020, 1013, 1012, 1013, 1004, 998, 988, 984, 981, 979, 976, 974, 971, 964, 967, 970, 943, 944, 947, 971, 189, 964, 976, 978, 1012, 1013, 959, 67, 113, 900, 861, 863, 857, 865, 852, 846, 850, 850, 105, 440, 443, 445, 451, 462, 464, 472, 479, 490, 464, 504, 514, 523, 528, 534, 549, 553, 563, 573, 573, 553, 579, 585, 591, 645, 646, 672, 713, 710, 725, 715, 701, 702, 702, 704, 713, 720, 731, 741, 742, 748, 757, 765, 776, 781, 785, 791, 800, 801, 816, 822, 829, 837, 853, 855, 870, 883, 890, 911, 914, 915, 917, 919, 920, 919, 922, 926, 928, 933, 935, 937, 940, 942, 940, 958, 956, 958, 959, 957, 957, 965, 971, 972, 974, 973, 1113, 560, 550, 536, 519, 507, 485, 478, 465, 392, 395, 401, 412, 411, 431, 429, 417, 427, 430])
  
# Escalar los datos para mejorar el entrenamiento de la red neuronal
input_data_scaled = ([[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]])
for i in range (16):
    input_data_scaled[i] =input_data[i] / np.max(input_data[i])

#input_data_scaled = input_data / np.max(input_data)
output_data_scaled = output_data / np.max(output_data)

combined_input_data = np.column_stack(input_data_scaled)

# Construir la red neuronal
model = keras.Sequential([
    keras.layers.Dense(64, activation='relu', input_shape=(16,)),
    keras.layers.Dense(64, activation='relu'),
    keras.layers.Dense(1)
])

# Compilar el modelo
model.compile(optimizer='adam', loss='mse')

# Entrenar el modelo
model.fit(combined_input_data, output_data_scaled, epochs=5000, verbose=0)



# Funci√≥n que se ejecuta cuando el cliente se conecta al broker
def on_connect(client, userdata, flags, rc):
    print("Conectado con c√≥digo resultante: " + str(rc))
    client.subscribe(mqtt_topic)  # Suscribirse al topic


# Funci√≥n que se ejecuta cuando se recibe un mensaje
def on_message(client, userdata, msg):

    try:
        if msg.topic == mqtt_topic:
            print(f"Mensaje recibido en el topic {msg.topic}: {msg.payload.decode()}")

            cadena_texto = msg.payload.decode()  # Convertir la cadena de bytes a una cadena de texto
            cadena_limpia = cadena_texto.strip("b'")  # Eliminar el prefijo b' de la cadena
            valores = cadena_limpia.split(",")  # Dividir la cadena en una lista de cadenas utilizando la coma como delimitador
            valores = [int(valor) for valor in valores if valor.strip()]
            print(valores)
            enteros = [int(valor) for valor in valores]  # Convertir cada cadena en la lista a un entero
            print(enteros)
            arreglo_numeros = enteros

            print(arreglo_numeros)
            
            input_value_scaled = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            for i in range (16):
                input_value_scaled[i] = arreglo_numeros[i] / np.max(input_data[i])
                    #input_value_scaled = input_value / np.max(input_data)
            combined_input_value = np.array([input_value_scaled])

                    # Realizar la predicci√≥n con la red neuronal
                
            output_value_scaled = model.predict(np.array([input_value_scaled]))

                    # Desescalar el valor de salida para obtener el resultado final

            output_value = output_value_scaled * np.max(output_data)

                    # Mostrar el resultado
                    
            print("Resultado de la red neuronal para el valor de entrada ingresado:")
            with open('VALORES/Irradiancia.txt', 'w') as f:
                f.write(str(output_value[0][0]))
            print(output_value[0][0])  # Convertir el resultado a un n√∫mero escalar

    except Exception as e:
            print(f"Se produjo un error: {e}")  
        

    print(msg.topic + " " + str(msg.payload))
# Crear una instancia del cliente MQTT
client = mqtt.Client()

# Configurar funciones de callback
client.on_connect = on_connect
client.on_message = on_message

# Conectar al broker MQTT
client.connect(mqtt_broker, mqtt_port, 60)

# Iniciar el loop para recibir mensajes
client.loop_forever()